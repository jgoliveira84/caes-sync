# Caes-Sync
Simple daemon to sync data between ElasticSearch and Cassandra.

## Installing

Download this repository, extract it, go to its root and do:
```shell 
$ python setup.py install
```

This will install Caes-Sync and all its dependencies.

## Running

We assume that you have already setup both an [ElasticSearch](https://www.elastic.co/ "Elastic Search") instance and a [Cassandra](http://cassandra.apache.org/ "Cassandra") one. Once Caes-Sync is instaled, you need an [Yaml](http://yaml.org) config file at ~/.caes/config.yaml where you are going to put ElasticSearch/Cassandra conection parameters and other caes-sync stuff. This file's semantics is described in the *Configuring* section.

To start Caes-Sync do:

```shell
caes-sync-daemon start
```

and to stop it:

```shell
caes-sync-daemon stop
```

Not surprisingly

```shell
caes-sync-daemon restart
```

will restart the daemon.

**Caes-Sync syncs data inserted/updated from the moment it starts only**. Use another tool to make a batch offline syncing.

## Schema

To make data syncing between heterogeneous technologies such as ElasticSearch and Cassandra possible, you need to conform your data to certain guidelines, mainly due to performance and/or consistency issues.

##### ElasticSearch 'schema'

ElasticSearch already has a 'built-in' field named *_timestamp* where the client application can provide a unix timestamp to associate with a document and make queries based on it. However, this field is not 'turned on' by default and you need, therefore, to have this mapping put on your index:

```javascript
{<type>: 
    {'_timestamp': 
      {
        'enabled': True, 
        'store': True
      }
    }
 }
```

This makes it possible for caes-sync to make fast range queries and get docs that where inserted/updated since the last sync.

We also need to garantue consistency across both 'databases'. For this we will rely on an optimistyc consistency control approach and use ElasticSearch's 'built-in' field *_version* along with *_version_type=external*. When indexing a document, you need to provide **the same value to _timestamp and _version**. So, your inserts/updates should look something like that:

```shell
$ curl -XPUT 'http://localhost:9200/<index>/<type>/ed31ee76-d49a-4c05-8f0a-6a856a94de8e?timestamp=1427254212&version=1427254212&version_type=external' -d '{
    "user" : "jgoliveira84",
    "message" : "Let's sync!!"
}'
```

##### Cassandra 'schema'

In Cassandra, what we need to do is provide a table that will act like the range query index, and also garantue consistency, since its entries will allways be ordered by the client-provided timestamp. So, we need to define a table like this 

```SQL
CREATE TABLE <timeseries_column_family> (
  <timeseries_id_fiel_dname> int,
  timestamp int,
  <data_id_field_name> uuid,
  PRIMARY KEY(<timeseries_id_field_name>, timestamp, <data_id_field_name>)
);
```
The field *data_id_fieldname* will reference another table, which in turn will have the actual data. This table can have the any fields you want, but keep in mind that you should make shure that all fields eventually comming from ElasticSearch have their counterparts on the *data_column_family*. That table needs to have a UUID type 4 Primary Key, and may look like

```SQL
CREATE TABLE <timeseries_column_family> (
  <data_id_field_name> uuid,
  vint int,
  vstring text,
  PRIMARY KEY(<data_id_field_name>)
);
```

When doing an insert/update you need to make it on both tables in a atomic way. So, your writes in Cassandra will look like

```SQL
BEGIN BATCH
    INSERT INTO <timeseries_column_family> (<timeseries_id_field_name>, <timeseries_field_name>, <data_id_field_name>) VALUES (?, ?, ?)
    INSERT INTO <data_column_family> (<data_id_field_name>, vstring, vint) VALUES (?, ?, ?)
APPLY BATCH;
```

##Configuring

You configure your Caes-Sync daemon by providing an [Yaml](http://yaml.org) file at ~/.caes/config.yaml. Here is an example of this file:

```Yaml
interval: 60

ElasticSearchConfig:
    index: stream
    type: log

CassandraConfig:
    keyspace: logs
    dataColumnFamily: data
    timeseriesColumnFamily: ts
    timeseriesIdFieldName: id
    dataIdFieldName: did
    timestampFieldName: timestamp

logging:
  version: 1

  formatters:
      simple:
        format:  '%(asctime)s %(levelname)s %(name)s %(message)s'
        datefmt: '%Y/%m/%d %H:%M:%S'

  handlers:
      console:
        class: logging.StreamHandler
        formatter: simple
        level: DEBUG

  loggers:
      caes:
        level: DEBUG
        handlers: [console]
        propagate: false

  root:
    level: INFO
    handlers: [console]
```

#####interval (required)

The interval, in seconds, between each sync cicle. It's important to guarantue that data generated by the client applications will be available to query in the "databases" within *interval* seconds, otherwise it won't be catched by the proper sync cycle. 

#####ElasticSearchConfig.index (required)

The index to use in ElasticSearch.

#####ElasticSearchConfig.type (required)

The type to use in ElasticSearch.

#####ElasticSearchConfig.include

Allow for a opt-in way of choosing what goes from ElasticSearch to Cassandra.

#####ElasticSearchConfig.exclude

Allow for a opt-out way of choosing what goes from ElasticSearch to Cassandra. It gets overhiden if *include* is present.

#####ElasticSearchConfig.driver

A dictionary containing kwargs that will be passed to the [ElasticSearch Driver](https://elasticsearch-py.readthedocs.org/en/master/api.html#elasticsearch.Elasticsearch).

#####CassandraConfig.keyspace (required)

The keyspace to use with Cassandra.

#####CassandraConfig.dataColumnFamily (required)

The table on Cassandra where to put the main data in.

#####CassandraConfig.timeseriesColumnFamily

The table on Cassandra where to put the timeseries index in. Defaults to 'ts'.

#####CassandraConfig.timeseriesIdFieldName

The name of the ID field on the *timeseriesColumnFamily*. Defaults to 'id'.

#####CassandraConfig.dataIdFieldName

The name of the ID field on the *dataColumnFamily* which is also referenced on the *timeseriesColumnFamily*. Defaults to 'did'.

#####CassandraConfig.timestampFieldName

The name of the timestamp field on the *timeseriesColumnFamily*. Defaults to 'timestamp'

#####CassandraConfig.driver

A dictionary containing kwargs that will be passed to the [Cassandra Driver](http://datastax.github.io/python-driver/api/cassandra/cluster.html#module-cassandra.cluster).

#####CassandraConfig.insertQuery

As Cassandra's data model relies on having your data put in diferent tables depending on each query pattern to leverage better performance, it is important to have felxibility on the inserts comming from Caes-Sync. This parameter allow you to provide insert/update queries which will be apended to a batch insert where the default *dataColumnFamily* and *timeseriesColumnFamily* are done:

```SQL
        BEGIN BATCH
                    INSERT INTO ts (id, timestamp, did) VALUES (0, %(ts)s, %(did)s) USING TTL 3600
                    INSERT INTO ydstcgkpjj (did, vint, vstring) VALUES (%(did)s, %(vint)s, %(vstring)s) 
                    
                    <insertQuery>
                                        
        APPLY BATCH;
```

You must use %(name)s style placeholders (allways with an 's'). The driver will unpack the values properly. Those are the names of the fields coming from ElasticSearch.

#####CassandraConfig.ttl

THe TTL, in seconds, of the *timeseriesColumnFamily*. It should be safelly set to a value greater than *interval*. Defaults to 3600 (one hour).


